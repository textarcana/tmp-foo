#!/usr/bin/env bash

set -Eaeuo pipefail -o functrace

source "$HOME/.stdlib.sh"

now_the_log_level_is_debug

# Shell Script State machine from
# http://blog.sarah-happy.ca/2010/12/shell-script-state-machine.html

print_one_line(){
    perl -lwe 'print $ENV{"line"}'
}

log here begins the DFA output:

start_function(){
    echo "initial state"
    print_one_line
    state="next"
}

next_function(){
    echo "next state"
    print_one_line
    state="done"
}

done_function(){
    echo "done"
    print_one_line
    state="start"
}

# Declare an Associative Array, a.k.a Hash Table, a.k.a. A bash Hash!
#
# This requires bash 4

declare -A states=(
    [start]=start_function
    [next]=next_function
    [done]=done_function
)

now_the_fsm_has_advanced_to_the_next_state(){
    $(eval "echo ${states[$state]}")
}

state="start"

while IFS= read -r line
do
    now_the_fsm_has_advanced_to_the_next_state
done < "$1"
